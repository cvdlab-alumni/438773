<!DOCTYPE html>
<html>
 <head> 
  <title>Homework 4 - Pixar Lamp in Three.js</title> 
  <style>
    body{
      margin: 0;
      overflow: hidden;
    }
  </style> 
  </head> 
  <body>
    <!-- JavaScript libraries -->
    <script src="assets/libs/three.min.js"></script> 
    <script src="assets/libs/jquery.min.js"></script> 
    <script src="assets/libs/Stats.min.js"></script>
    <script src="assets/libs/dat.gui.min.js"></script>
    <script src="assets/libs/TrackballControls.js"></script>

    <script type="text/javascript" src="assets/fonts/helvetiker_regular.typeface.js"></script> 
    <script type="text/javascript" src="assets/fonts/helvetiker_bold.typeface.js"></script> 
    <script type="text/javascript" src="assets/fonts/bitstream_vera_sans_mono_roman.typeface.js"></script> 

    <!-- Javascript code that runs our Three.js examples --> 
    <script>
      // once everything is loaded, we run our Three.js stuff.
      $(  

        function () {
		      
          /////////////////////////////
          // Configurations Variables
          // STANLEY
          /////////////////////////////

          //Camera
          var cameraX = -60;
          var cameraY = 20;
          var cameraZ = 30;
          var lookUpVector = new THREE.Vector3(0,1,0);

          //Pivot Angle
          var alfaTo = Math.PI*2;
          var betaTo = Math.PI/2;
          var gammaTo = Math.PI/2;
          var gamma2To = Math.PI*2;
          var epslonTo = Math.PI/2;

          //Variables's arm
          var rTop = 2;
          var rBottom = 2;
          var heightArm = 20;
          var segmentO = 20;

          //Variables's base
          var rTopBase = 15;
          var rBottomBase = 15;
          var heightBase = 2;

          //Variables's pivot
          var radius = 2;

          //Variables's lamp
          var r1 = 5;
          var r2 = 7;
          var r3 = 15; 
          var heightCono = 10;

          //Phong Options
          var phongOptions = { 
                               specular: 0xffffff, 
                               color: 0x3399ff, 
                               shininess: 100, 
                               metal: true
                             };

          var angleRotate = Math.PI/2;

          /////////////////////////////
          /////////////////////////////

      		scene = new THREE.Scene()
      		
      		var camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
          camera.position.set(cameraX,cameraY,cameraZ);
          camera.up = lookUpVector;
          camera.lookAt(scene.position);

          var inspectedCamera = new THREE.PerspectiveCamera(10, window.innerWidth / window.innerHeight, 10, 1);
          var trackballControls = new THREE.TrackballControls(camera);
          var axisHelper = new THREE.AxisHelper(3);

      		var renderer = new THREE.WebGLRenderer();
          renderer.setClearColor(new THREE.Color(0xEEEEEE));
          renderer.setSize(window.innerWidth, window.innerHeight);

          var pointColor = "#ff5808";
          var directionalLight = new THREE.DirectionalLight( 0xffffff );
          directionalLight.intensity = 0.5;
          directionalLight.position.set(-40,60,-10);

          /*
          directionalLight.castShadow = true;
          directionalLight.shadowCameraNear = 2;
          directionalLight.shadowCameraFar = 80;
          directionalLight.shadowCameraLeft = -40;
          directionalLight.shadowCameraRight = 40;
          directionalLight.shadowCameraTop = 40;
          directionalLight.shadowCameraBottom = -40;

          directionalLight.intensity = 0.5;
          directionalLight.shadowMapHeight = 1024;
          directionalLight.shadowMapWidth = 1024;
          */

          var cubeGeometry = new THREE.PlaneGeometry(500,500);
          //var meshMaterial = new THREE.MeshLambertMaterial({color: 0x3CB371});
          //var plane = new THREE.Mesh(cubeGeometry, meshMaterial);
          phongOptions['color'] = '0x3CB371';
          var plane = createMesh(cubeGeometry , "lambert" , {color: 0x3CB371})
          plane.position.set(0,0,0);
          plane.rotation.x=-0.5*Math.PI;

          var options = {color: 0x04FE32}
          var j1 = createJoint(heightArm , radius);
          var j2 = createJoint(heightArm , radius);
          var pivotTop = generatePivot(radius,2);

          j1.attach.add(j2);
          j2.attach.add(pivotTop);
          //positioning j1 on base
          j1.position.y = 1;

          var base = generateCylinder(heightBase , 0 , rTopBase , rBottomBase , phongOptions , "phong");
          base.add(j1);
          base.position.set(0,2,150);

          //create lamp
          var lamp = createTopLamp(r1,r2,r3,heightCono,segmentO,radius);
          j2.attach.add(lamp);

          var options = {
            size: 85,
            height: 22,
            bevelThickness: 1.3,
            bevelSize: 1.65,
            bevelSegments: 15,
            bevelEnabled: true,
            curveSegments: 20,
          };

          c = createMesh(new THREE.TextGeometry("C", options), "phong");
          v = createMesh(new THREE.TextGeometry("v", options) , "phong");
          d = createMesh(new THREE.TextGeometry("d", options), "phong");
          l = createMesh(new THREE.TextGeometry("l", options), "phong");
          a = createMesh(new THREE.TextGeometry("a", options), "phong");
          b = createMesh(new THREE.TextGeometry("b", options), "phong");

          c.position.set(-150,2,0);
          v.position.set(-60,2,0);
          d.position.set(0,2,0);
          l.position.set(70,2,0);
          a.position.set(100,2,0);
          b.position.set(170,2,0);


          scene.add(camera);
          scene.add(base);
          //scene.add(lamp);
          scene.add(axisHelper);
          scene.add(plane);
          scene.add(directionalLight);

          scene.add(c);
          scene.add(v);
          scene.add(d);
          scene.add(l);
          scene.add(a);
          scene.add(b);

          var controls = new function() {
            this.pivot_alfa = 0;
            this.pivot_beta = 0;
            this.pivot_gamma = 0;
            this.pivot_gamma2 = 0;
            this.pivot_epslon = 0;
          }

          // PERCHE SE METTE LA ROTAZIONE SU X Y Z NON VA ? 
          var gui = new dat.GUI();
          gui.add(controls, 'pivot_alfa',0,alfaTo).onChange(function (e){
            j1.rotation.y = e;
          });
          gui.add(controls, 'pivot_beta',0,betaTo).onChange(function (e){
            j1.pivot.rotation.x = e;
          });
          gui.add(controls , 'pivot_gamma',0,gammaTo).onChange(function (e){
            j2.pivot.rotation.x = e;
          });
          gui.add(controls , 'pivot_gamma2',0,gamma2To).onChange(function (e){
            j2.rotation.y = e;
          });
          gui.add(controls , 'pivot_epslon',0,epslonTo).onChange(function (e){
            lamp.pivot.rotation.x = e;
          });

          $('body').append(renderer.domElement)
          
          animation();

          function animation(){

            trackballControls.update();
            requestAnimationFrame(animation);
            renderer.render(scene, camera);
          }

          function generateCylinder(height , trasl , rTop , rBottom , options , meshType){
            var planeGeometry = new THREE.CylinderGeometry(rBottom,rTop,height,segmentO);
            var cylinder = createMesh(planeGeometry,meshType,options)
            cylinder.position.set(0,trasl,0);
            
            return cylinder;
          }

          function generateSphere(radius ,vertical , horizontal , options){
            var geometry_m = new THREE.SphereGeometry(radius,vertical,horizontal);
            var sphere = createMesh(geometry_m,"phong",options)

            return sphere
          }

          function generatePivot(radius , transl){
            var pin = generateSphere(radius,20,20);
            pin.position.set(0,transl,0);

            return pin;
          }

          function createJoint(height , radius){

            var options = {
                            color: 0x2E8B57
                          };

            var joint = new THREE.Object3D();

            phongOptions['color'] = 0xa331e0;
            var cylinder = generateCylinder(heightArm , (heightArm/2)+radius , rTop , rBottom ,
                           phongOptions , "phong");

            phongOptions['color'] = 0xa314e0;
            var pivot = generatePivot(radius , 2 , phongOptions);
            pivot.add(cylinder);

            var attach = new THREE.Object3D();
            attach.position.set(0,(heightArm/2),0);
            cylinder.add(attach);

            joint.pivot = pivot;
            joint.arm = cylinder;
            joint.attach = attach;

            joint.add(pivot);

            return joint;
          }

          function radialWave(u , v){

             var r = 2;
             var x = Math.sin(u * 2 * Math.PI) * r;
             var y = 3
             var z = Math.cos(v * 2 * Math.PI) * r;
             return new THREE.Vector3(x, y, z);
          }

          function createMesh(geometry , meshType , options){

            var meshMaterial;
            switch(meshType){
              case "phong":
              meshMaterial = new THREE.MeshPhongMaterial(options);
                break;
              case "basic":
                break;
              case "lambert":
                meshMaterial = new THREE.MeshLambertMaterial(options);
                break;
            }
            meshMaterial.doubleSide = true;
            var mesh = new THREE.Mesh(geometry , meshMaterial);

            return mesh;
          }

          function createTopLamp(r1,r2,r3,height,segmentO,radius){

            // TODO ADD LAMP AND SPOTLIGHT
            
            var conoGeom = new THREE.CylinderGeometry(r2,r1,height,segmentO);
            var sphereGeom = new THREE.SphereGeometry(r3,20,20,6,6.3,1.4,1.5);
            var pivot = generatePivot(radius,radius);

            /*var extrudeGeometryCono =  new THREE.ExtrudeGeometry(conoGeom , { amount: 2 , 
                                                               bevelThickness: 0,
                                                               bevelSize: 0});
            var extrudeGeometryCono2 =  new THREE.ExtrudeGeometry(conoGeom2 , { amount: 2 , 
                                                               bevelThickness: 0,
                                                               bevelSize: 0});
            */

            phongOptions['color'] = 0x3399ff;
            var cono = createMesh(conoGeom , "phong" , phongOptions);
            var sphere = createMesh(sphereGeom , "phong" ,phongOptions);
            var bulb = generateSphere(r1-0.5,segmentO,segmentO,{color:0xffffff});

            cono.position.set(0,(height+radius)/2,0);
            sphere.position.set(0,(height-1+r3),0);
            sphere.material.side = THREE.DoubleSide;

            pivot.add(sphere);
            pivot.add(cono);

            //Add light to lamp
            var fooTarget = generateSphere(r1-0.5,segmentO,segmentO,{color:0xffffff});
            fooTarget.position.y = 30;
            var pointColor = "#FFD700";
            /*var spotLight = new THREE.SpotLight(pointColor);
            spotLight.target = fooTarget;
            spotLight.distance = 200;
            spotLight.angle = 0.75;
            spotLight.exponent = 1;
            spotLight.intensity = 40;*/

            /*
            spotLight.castShadow = true;
            spotLight.shadowCameraNear = 2;
            spotLight.shadowCameraFar = 50;
            spotLight.shadowCameraFov = 70;
            spotLight.shadowDarkness = 0.5;
            spotLight.shadowMapWidth = 256;
            spotLight.shadowMapHeight = 256;
            */

            var spotLight = new THREE.SpotLight(0xffffff);
            spotLight.intensity = 5;
            spotLight.angle = Math.PI/6;
            spotLight.target = fooTarget;
            spotLight.castShadow = true;
            //spotLight.shadowCameraVisible = true;
            //spotLight.shadowCameraNear = Math.abs(cube.position.x - firstOrientablePin.position.x) + 5;
            //spotLight.shadowMapWidth = 1024;
            //spotLight.shadowMapHeight = 1024;
            
            bulb.position.y = 4;
            bulb.add(spotLight);
            bulb.add(fooTarget);
            cono.add(bulb);
        
            var topLamp = new THREE.Object3D();
            topLamp.pivot = pivot;
            topLamp.light = spotLight;

            topLamp.add(pivot);

            return topLamp;
          }

          function addJoint2Arm(num_join){

            if(num_join === 1){
              return createArm();
            }

            var joint = createArm();
            return joint.pivot.add(addJoint2Arm(--num_join));
          }

         });
    </script>  
 </body>
</html>
